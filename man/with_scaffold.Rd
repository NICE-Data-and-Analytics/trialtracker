% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/dashboard_helpers.R
\name{with_scaffold}
\alias{with_scaffold}
\title{Dashboard helper functions (SQL generation, DB access, and text sanitisation)}
\usage{
with_scaffold(
  source_table,
  id_col,
  ids_source_col,
  lookback_days = 31L,
  ids_table = "Trial_Ids",
  con = pool_con
)
}
\arguments{
\item{source_table}{Table/view containing historical snapshots.}

\item{id_col}{Identifier column used for joins.}

\item{ids_source_col}{Column in \code{ids_table} containing raw ID values.}

\item{lookback_days}{Number of days to look back when selecting the "old" snapshot.}

\item{ids_table}{Table containing the list of IDs to include.}

\item{con}{DBI connection used for identifier quoting in \code{glue::glue_sql()}.}
}
\value{
A DBI SQL object.
}
\description{
Internal utilities used by the trialtracker dashboard. This file contains:
\itemize{
\item SQL code-generation helpers that emit common CTE and other scaffolding
\item Safe wrappers around DBI queries to prevent UI-breaking errors
\item Text cleaning and encoding utilities for reliable rendering
}
}
\details{
These functions are not part of the public package API. They exist to:
\itemize{
\item Keep the dashboard Rmd thin and focused on UI/server wiring
\item Centralise SQL-generation logic in testable package code
\item Provide defensive handling of database and encoding edge cases
}

Emit common CTE scaffolding used by dashboard SQL queries

Generates a DBI SQL fragment containing the shared CTE structure used across
snapshot-comparison queries in the dashboard. The emitted CTEs are:
\itemize{
\item \code{ids}: distinct, trimmed IDs from \code{ids_table}
\item \code{first_seen}: earliest observed \code{Query_Date} per ID (as a calendar date)
\item \code{latest}: most recent \code{Query_Date} per ID
\item \code{n}: rows from \code{source_table} at the latest snapshot per ID
\item \code{o_pick}: most recent row on or before \code{latest_qd - lookback_days}
\item \code{o}: rows from \code{source_table} at the selected older snapshot per ID
}

Assumes \code{source_table} contains a numeric \code{Query_Date} column expressed
as days since 1970-01-01. This function does not execute SQL; it only generates
a safely quoted fragment for inclusion in larger queries.
}
\keyword{internal}
