---
title: "Trial Tracker Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
runtime: shiny
---

```{r setup, context = 'setup'}

# TODO

#Front end
# 1) Add error handling controls for on adding IDS (pattern match) 
# 2) Add in tickbox for impact / no impact

#Backend
# 1) PURGE dot/space from Guideline number field - rename ID fields in registry_fields equal to names in Trial_Ids
# 2) Move formatting/manipulation from markdown back to update script (and possibly back to initial input script from s-sheet)

library(tidyverse)
library(lubridate)
library(DBI)
library(flexdashboard)
library(DT)
library(compareDF)
library(shiny)
library(shinybusy)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

#setwd('//srv/shiny-server/trialtracker')

con <- dbConnect(RSQLite::SQLite(), "RSQLite_Data/TrialTracker-db.sqlite")

Ids <- dbReadTable(con, "Trial_Ids")

clean_UTF <- function(x){
  iconv(x, "UTF-8", "UTF-8", sub = "")
}

```

Live Trial Info
======================================================

**Last refreshed: `r file.info("RSQLite_Data/TrialTracker-db.sqlite")$mtime`**

Row {.tabset .tabset-fade}
--------------------------------------------------------

### ClinicalTrials.gov

```{r CTG table}

dbReadTable(con, "NCT") %>%
  filter(NCTId %in% Ids$NCT_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE) %>%
  select(-Query_Date, -SeeAlsoLinkURL) %>%
  mutate(across(.fns = clean_UTF),
         PrimaryCompletionDate = mdy(PrimaryCompletionDate),
         CompletionDate = mdy(CompletionDate),
         ResultsFirstSubmitDate = mdy(ResultsFirstSubmitDate),
         LastUpdatePostDate = mdy(LastUpdatePostDate)
         )%>% 
  rename(
    Guideline = Guideline.number,
    `NCT ID` = NCTId,
    `Org ID` = OrgStudyId,
    Title = BriefTitle,
    Status = OverallStatus,
    `Primary Completion Date` = PrimaryCompletionDate,
    `Completion Date` = CompletionDate,
    `Results Submit Date` = ResultsFirstSubmitDate,
    `Results Post Date` = ResultsFirstPostDate,
    `Last Update` = LastUpdatePostDate,
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE),
            filter = "top"
            )
```

### ISRCTN

```{r ISRCTN table}

dbReadTable(con, "ISRCTN") %>%
  filter(ISRCTN_No %in% Ids$ISRCTN_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE) %>%
  select(-Query_Date) %>%
  mutate(across(.fns = clean_UTF),
         Results_date_completed = dmy(Results_date_completed),
         Results_date_posted = dmy(Results_date_posted),
         Results_date_first_publication = dmy(Results_date_first_publication)) %>% 
  rename(
    Guideline = Guideline.number,
    `ISRCTN ID` = ISRCTN_No,
    Title = Public_Title,
    `Scientific Title` = Scientific_Title,
    `Recruitment Status` = Recruitment_Status,
    `Results completed date` = Results_date_completed,
    `Results URL` = Results_url_link,
    `Results summary` = Results_summary,
    `Results posted date` = Results_date_posted,
    `Results published date` = Results_date_first_publication
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
```

### NIHR

``` {r NIHR table}

dbReadTable(con, "NIHR") %>%
  filter(project_id %in% Ids$NIHR_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE) %>%
  select(-Query_Date) %>%
  mutate(across(.fns = clean_UTF)) %>% 
  rename(
    Guideline = Guideline.number,
    `NIHR ID` = project_id,
    `Project Title` = project_title,
    Status = project_status,
    `End Date` = end_date
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
```

### Clinicaltrials.eu

``` {r EU table}

dbReadTable(con, "EU") %>%
  mutate("short_id" = str_sub(`X_id`, 1, 14)) %>% 
  filter(short_id %in% Ids$EU_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE) %>%
  select(
    -Query_Date, -a31_title_of_the_trial_for_lay_people_in_easily_understood_ie_nontechnical_language, -EU_Ids, -short_id
  ) %>%
  mutate(across(.fns = clean_UTF)) %>% 
  distinct() %>% 
  rename(
    Guideline = Guideline.number,
    `Clinicaltrials.eu ID` = `X_id`,
    `End of Trial Status` = p_end_of_trial_status,
    Title = a3_full_title_of_the_trial,
    `Abbreviated Title` = a32_name_or_abbreviated_title_of_the_trial_where_available,
    `Sponsor ID` = a41_sponsors_protocol_code_number
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```



Recent Status Changes
======================================================

**Last refreshed: `r file.info("RSQLite_Data/TrialTracker-db.sqlite")$mtime`**  
**Changes are from 31 days ago**

Row {.tabset .tabset-fade}
--------------------------------------------------------

### ClinicalTrials.gov

``` {r CGT monthly change}

new_df <- dbReadTable(con, "NCT") %>%
  filter(NCTId %in% Ids$NCT_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE)

old_df <- dbReadTable(con, "NCT") %>%
  filter(Query_Date <= Sys.Date() - 31,
	NCTId %in% Ids$NCT_Ids) %>% 
  slice_max(Query_Date, n=1, with_ties = TRUE)

compare_df(new_df,
           old_df,
           group_col = c("Guideline.number", "NCTId"),
           exclude = "Query_Date",
           stop_on_error = FALSE
           )$comparison_df %>%
  mutate(#`Query Date` = as.Date(Query_Date, origin = "1970-01-01"),
         URL2 = paste0("https://clinicaltrials.gov/ct2/show/", NCTId),
         Title = str_trunc(BriefTitle, 80),
         Condition = str_trunc(Condition, 30)) %>% 
  mutate(across(.fns = clean_UTF),
         CompletionDate = mdy(CompletionDate),
         ResultsFirstSubmitDate = mdy(ResultsFirstSubmitDate),
         LastUpdatePostDate = mdy(LastUpdatePostDate)
         ) %>% 
  select(
    `Change` = chng_type,
    Guideline = Guideline.number,
#    `Query Date`,
    URL = URL2,
#   ID = NCTId,
    Acronym,
    Title,
    Condition,
    Status = OverallStatus,
    `Completion Date` = CompletionDate,
    `Results Submit Date` = ResultsFirstSubmitDate,
    `Last Update Date` = LastUpdatePostDate,
  ) %>% 
datatable(
  options = list(bPaginate = FALSE, scrollY = TRUE),
                 filter = "top")
  

```

### ISRCTN

``` {r ISRCTN monthly change}

new_df <- dbReadTable(con, "ISRCTN") %>%
  filter(ISRCTN_No %in% Ids$ISRCTN_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE)

old_df <- dbReadTable(con, "ISRCTN") %>%
  filter(Query_Date <= Sys.Date() - 31,
 	 ISRCTN_No %in% Ids$ISRCTN_Ids) %>% 
  slice_max(Query_Date, n=1, with_ties = TRUE)

compare_df(new_df,
           old_df,
           group_col = c("Guideline.number", "ISRCTN_No"),
           exclude = "Query_Date",
           stop_on_error = FALSE)$comparison_df %>%
  mutate(#`Query Date` = as.Date(Query_Date, origin = "1970-01-01"),
         Title = str_trunc(Scientific_Title,75)) %>% 
  mutate(across(.fns = clean_UTF),
         Results_date_completed = dmy(Results_date_completed),
         Results_date_posted = dmy(Results_date_posted),
         Results_date_first_publication = dmy(Results_date_first_publication)
         ) %>% 
  select(Change = chng_type,
         Guideline = Guideline.number,
         URL,
#         `Query Date`,
         Acronym,
         Title,
         Status = Recruitment_Status,
         `Results URL` = Results_url_link,
         `Results Summary` = Results_summary,
         `Results Completed` = Results_date_completed,
         `Results Posted` = Results_date_posted,
         `Results Published` = Results_date_first_publication) %>% 
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

### NIHR

``` {r NIHR monthly change}

new_df <- dbReadTable(con, "NIHR") %>%
  filter(project_id %in% Ids$NIHR_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE)

old_df <- dbReadTable(con, "NIHR") %>%
  filter(Query_Date <= Sys.Date() - 31,
	 project_id %in% Ids$NIHR_Ids) %>% 
  slice_max(Query_Date, n=1, with_ties = TRUE)

compare_df(
  new_df,
  old_df,
  group_col = c("Guideline.number", "project_id"),
  exclude = "Query_Date",
  stop_on_error = FALSE
)$comparison_df %>%
  mutate(#`Query Date` = as.Date(Query_Date, origin = '1970-01-01'),
         Title = str_trunc(project_title, 90)) %>% 
  mutate(across(.fns = clean_UTF)) %>% 
  select(
    Change = chng_type,
    Guideline = Guideline.number,
#    `Query Date`,
    URL,
    Guideline = Guideline.number,
    `NIHR ID` = project_id,
    Title,
    Status = project_status,
    `End Date` = end_date
         ) %>% 
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

### Clinicaltrials.eu

``` {r Clinicaltrials.eu monthly change}

new_df <- dbReadTable(con, "EU") %>%
  filter(EU_Ids %in% Ids$EU_Ids) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE)

old_df <- dbReadTable(con, "EU") %>%
  filter(Query_Date <= Sys.Date() - 31,
	 EU_Ids %in% Ids$EU_Ids
	) %>% 
  slice_max(Query_Date, n = 1, with_ties = TRUE)

compare_df(
  new_df,
  old_df,
  group_col = c("Guideline.number", "EU_Ids"),
  exclude = "Query_Date",
  stop_on_error = FALSE
)$comparison_df %>%
  mutate(#`Query Date` = as.Date(Query_Date, origin = "1970-01-01"),
         Title = str_trunc(a3_full_title_of_the_trial, 90)) %>% 
  mutate(across(.fns = clean_UTF)) %>% 
  select(
    Change = chng_type,
    Guideline = Guideline.number,
#    `Query Date`,
    URL,
    `EU ID` = EU_Ids,
    Status = p_end_of_trial_status,
    Acronym = a32_name_or_abbreviated_title_of_the_trial_where_available,
    Title) %>% 
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

Pubmed Publications
======================================================

**Last refreshed: `r file.info("RSQLite_Data/TrialTracker-db.sqlite")$mtime`**

Row {.tabset .tabset-fade}
--------------------------------------------------------

### ClinicalTrials.gov

``` {r CTG pubs table}

dbReadTable(con, "NCT_PM") %>%
  mutate(across(.fns = clean_UTF)) %>% 
  mutate(Query_Date = format(as.Date(as.numeric(Query_Date), origin = "1970-01-01"), "%Y/%m/%d"),
         abstract = str_trunc(abstract, 200)) %>%
  select(
    `Guideline` = Guideline.number,
    `Query Date` = Query_Date,
    `Trial ID` = ID,
#    `Trial URL` = URL,
    PMID = pmid,
    `Publication DOI` = doi,
    Title = title,
    Abstract = abstract,
    Journal =  jabbrv,
    Condition = Short..working.title.
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
```

### ISRCTN

``` {r ISRCTN pubs table}

dbReadTable(con, "ISRCTN_PM") %>%
  mutate(across(.fns = clean_UTF)) %>% 
  mutate(Query_Date = format(as.Date(as.numeric(Query_Date), origin = "1970-01-01"), "%Y/%m/%d"),
         abstract = str_trunc(abstract, 200)) %>%
  select(
    `Guideline` = Guideline.number,
    `Query Date` = Query_Date,
    `Trial ID` = ID,
#    `Trial URL` = URL,
    PMID = pmid,
    `Publication DOI` = doi,
    Title = title,
    Abstract = abstract,
    Journal =  jabbrv,
    Condition = Short..working.title. ##cut this out due to non-UTF-8 character
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
```

### NIHR

``` {r NIHR pubs table}

dbReadTable(con, "NIHR_PM") %>%
  mutate(across(.fns = clean_UTF)) %>% 
  mutate(Query_Date = format(as.Date(as.numeric(Query_Date), origin = "1970-01-01"), "%Y/%m/%d"),
         abstract = str_trunc(abstract, 200)) %>%
  select(
    `Guideline` = Guideline.number,
    `Query Date` = Query_Date,
    `Trial ID` = ID,
#    `Trial URL` = URL,
    PMID = pmid,
    `Publication DOI` = doi,
    Title = title,
    Abstract = abstract,
    Journal =  jabbrv,
    Condition = Short..working.title.
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
```

### Clinicaltrials.eu

``` {r EU pubs table}

if ("EU_PM" %in% dbListTables(con)) {
  dbReadTable(con, "EU_PM") %>%
    mutate(across(.fns = clean_UTF)) %>% 
    mutate(Query_Date = format(as.Date(as.numeric(Query_Date), origin = "1970-01-01"), "%Y/%m/%d"),
         abstract = str_trunc(abstract, 200)) %>%
    select(
      `Guideline` = Guideline.number,
      `Query Date` = Query_Date,
      `Trial ID` = ID,
#      `Trial URL` = URL,
      PMID = pmid,
      `Publication DOI` = doi,
      Title = title,
      Abstract = abstract,
      Journal =  jabbrv,
      Condition = Short..working.title.,
    ) %>%
    datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")
}
```

Add/Remove Trials and Trial Comments
======================================================

Row {.tabset .tabset-fade}
--------------------------------------------------------

### Add Trial

There are two ways to add trials

1) Add one at a time, choosing the relevant registry button, completing the guideline number, trial id and url boxes then pressing 'add trial'
2) Add more than one trial at once by uploading a spreadsheet containing relevant details using the 'choose file' box

**Note that Trial ID reference number must be in the correct format. Eg:**

Clinicaltrials.gov - "NCT03883230"
ISRCTN - "ISRCTN11735271"
NIHR - "14-158-02" or "RP-PG-0109-10056" (separate groups with a dash ('-') not a forward slash ('/'))
Clinicaltrials.eu - "2007-003673-21" (omit the last two letters designating country)


``` {r AddSingleTrial}

## ADD in condition (short.working.title) as additional field

inputPanel("Add Single Trial",
  radioButtons(
    "registry_add",
    label = "",
    choices = c("Clinicaltrials.gov" = 'NCT_Ids',
                "ISRCTN" = 'ISRCTN_Ids',
                "NIHR" = 'NIHR_Ids',
                "Clinicaltrials.eu" = 'EU_Ids')
  ),
  textInput('guideline_reference_add', label = 'Enter guideline number(s)', placeholder = "e.g. CG179"),
  textInput('ID_add', label = 'Enter Trial ID reference number', placeholder = " e.g. NCT03597750"),
  textInput('URL_add',
            label = 'Paste URL to trial page in registry',
            placeholder = "e.g. https://clinicaltrials.gov/ct2/show/NCT03597750",
            width = '200%'),
  actionButton("button_add", "Add trial")
)

mainPanel(textOutput('success'))

#NB NEED TO GO BACK AND PURGE DOT FROM FIELD - ADDED SQ BRACKETS AS WORKAROUND FOR NOW

sql_add <-
     "INSERT INTO Trial_Ids ([Guideline.number], [URL], [?registry]) VALUES (?Guideline_Reference, ?URL, ?ID)"

exp_add <- reactive({
  sqlInterpolate(
    con,
    sql_add,
    registry = SQL(input$registry_add),
    Guideline_Reference = input$guideline_reference_add,
    URL = str_trim(input$URL_add),
    ID = str_trim(input$ID_add))
})

observeEvent(input$button_add, {

  shinybusy::show_modal_spinner(spin = "semipolar", color = "#344feb", text = "Adding Trial - please wait while the dashboard refreshes in background....")

  dbExecute(con, exp_add())
  
  source('Download_Trial_Info_no_PM_or_email.R')

  shinybusy::remove_modal_spinner()

  output$success <- renderText("Trial Added! - please refresh browser to see trial details on Live Trial Info tab")

})

```

``` {r AddMultiTrial}

inputPanel("Add Multiple Trials via csv file",
  downloadButton('downloadtemplate', label = "Download template"),
  fileInput('uploadtemplate', label = 'Upload completed template', multiple = FALSE, accept = '.csv'),
  actionButton("button_add_multi", label = "Add trial spreadsheet"))


output$downloadtemplate <- downloadHandler(filename = function(){"trialuploadtemplate.csv"},
                                           content = function(file){
                                             write_csv(read_csv("trialuploadtemplate.csv",
                                                                col_types = cols(.default = col_character())),
                                                       file, na = "")})



to_add <- reactive({

  inFile <- input$uploadtemplate

  upload <- read_csv(file = inFile$datapath, col_types = cols(.default = col_character()))

})

#error check
observeEvent(input$uploadtemplate, {

  # output$baddabing <- renderText("Badda-Bing")
  # output$tab <- renderTable({to_add()})

  NCT_check <- str_detect(replace_na(to_add()$NCT_Ids, ''), "NCT[0-9]{8}")
  EU_check <- str_detect(replace_na(to_add()$EU_Ids, ''), "[0-9]{4}-[0-9]{6}-[0-9]{2}")
  ISRCTN_check <- str_detect(replace_na(to_add()$ISRCTN_Ids, ''), "ISRCTN[0-9]{8}")
  NIHR_pattern <- str_detect(replace_na(to_add()$NIHR_Ids, ''), "((?<=hta/|hsdr/|eme/|phr/)[0-9]{6,8})|(RP-PG-[0-9]{4}-[0-9]{4,5})")

  # output$NCT_check <- renderText({as.character(NCT_check)})

  Valid_ID <- {NCT_check|EU_check|ISRCTN_check|NIHR_pattern}

  # output$valids <- renderText({as.character(Valid_ID)})

  errors <- which(Valid_ID == FALSE)

  output$errors <- renderText({paste0("errors = ", as.character(errors))})
  output$errors_length <- renderText({paste0("errors_length = ", as.character(length(errors)))})

  if (length(errors)>0){

  output$multi_error <- renderText({paste("ERROR - missing or incorrect Trial ID on line(s)", as.character(errors))})

  }

})

#observe event add
observeEvent(input$button_add_multi, {

  NCT_check <- str_detect(replace_na(to_add()$NCT_Ids, ''), "NCT[0-9]{8}")
  EU_check <- str_detect(replace_na(to_add()$EU_Ids, ''), "[0-9]{4}-[0-9]{6}-[0-9]{2}")
  ISRCTN_check <- str_detect(replace_na(to_add()$ISRCTN_Ids, ''), "ISRCTN[0-9]{8}")
  NIHR_pattern <- str_detect(replace_na(to_add()$NIHR_Ids, ''), "((?<=hta/|hsdr/|eme/|phr/)[0-9]{6,8})|(RP-PG-[0-9]{4}-[0-9]{4,5})")

  #output$NCT_check <- renderText({as.character(NCT_check)})

  Valid_ID <- {NCT_check|EU_check|ISRCTN_check|NIHR_pattern}

  #output$valids <- renderText({as.character(Valid_ID)})

  multi_errors <- which(Valid_ID == FALSE)

  output$multi_errors <- renderText({paste0("multi_errors = ", as.character(multi_errors))})
  output$multi_errors_length <- renderText({paste0("multi_errors_length = ", as.character(length(multi_errors)))})

  if (length(multi_errors)==0){

  #output$multi_success1 <- renderText("Adding Trials - please wait while the dashboard refreshes in background....")

  shinybusy::show_modal_spinner(spin = "semipolar", color = "#344feb", text = "Adding Trials - please wait while the dashboard refreshes in background....")

  DBI::dbAppendTable(con, "Trial_Ids", to_add())

  # withProgress(message = "Adding Trials", {
    source('Download_Trial_Info - no PM call.R')
  #   incProgress(amount = 1)
  # })

  shinybusy::remove_modal_spinner()

  output$multi_success2 <- renderText("Multiple Trials Added! - please refresh browser to see trial details on Live Trial Info tab")

  } else if (length(multi_errors)>0){

  output$multi_fail <- renderText("Please correct errors in trial ID numbers on upload sheet before resubmitting")

  }

})

# mainPanel(textOutput('baddabing'),
#           tableOutput('tab'),
#           textOutput('NCT_check'),
#           textOutput('valids'))

mainPanel(
  #textOutput('errors'),
  #textOutput('errors_length'),
  #textOutput('multi_errors'),
  #textOutput('multi_errors_length'),
  textOutput('multi_error'),
  textOutput('multi_fail'),
  #textOutput('multi_success1'),
  textOutput('multi_success2'))

```

### Remove or Archive Trial

Select relevant registry and trial ID reference number below, along with any comments if archiving.

'Archiving' moves the trial information from the live lists to the relevant archived trials list, where it will no longer be updated. 'Deleting' will remove the trial from the live lists and information will not be stored

``` {r Remove tab}

inputPanel(
    radioButtons(
      "registry_remove",
      label = "Registry",
      choices = c(
        "Clinicaltrials.gov" = "NCT_Ids",
        "ISRCTN" = "ISRCTN_Ids",
        "NIHR" = "NIHR_Ids",
        "Clinicaltrials.eu" = "EU_Ids"
      )
    ),
    selectInput('ID_remove',
                label = 'Select Trial ID reference number',
                choices = ""),
    actionButton("button_delete", "Delete trial"),
    textInput("comments_archive", "Archive Comments"),
    actionButton("button_archive", "Archive trial")
  )

mainPanel(
  #textOutput("exp_archive"),
  #textOutput("exp_delete"),
  textOutput("success_delete"),
  textOutput("success_archive")
  )

observeEvent(input$registry_remove, {

  choices_list <- dbReadTable(con, "Trial_Ids") %>%
    select(ids = input$registry_remove) %>%
    drop_na() %>%
    arrange(str_remove_all(ids, "[A-Z]|-"))

  updateSelectInput(session, "ID_remove", choices = choices_list)

})

#SQL query to remove all lines with this trial
sql_delete <- "DELETE FROM Trial_Ids WHERE [?ColID] = ?ID_Selected"

exp_delete <- reactive({
  sqlInterpolate(
    con,
    sql_delete,
    ColID = SQL(input$registry_remove),
    ID_Selected = input$ID_remove
    )
})

#SQL to read in relevant rows
sql_archive <- "SELECT * FROM ?Orig_Table WHERE [?ColID] = ?ID_Selected"

exp_archive_pull <- reactive({
  sqlInterpolate(
    con,
    sql_archive,
    Orig_Table = SQL(str_sub(input$registry_remove, end=-5)),
    ColID = SQL(case_when(input$registry_remove == "NCT_Ids" ~ "NCTId",
                          input$registry_remove == "NIHR_Ids" ~ "project_id",
                          input$registry_remove == "ISRCTN_Ids" ~ "ISRCTN_No",
                          input$registry_remove == "EU_Ids" ~ "EU_Ids")),
    ID_Selected = input$ID_remove
  )
})

output$exp_delete <- renderText(exp_delete())
output$exp_archive <- renderText(exp_archive_pull())

observeEvent(input$button_delete, {

  shinybusy::show_modal_spinner(spin = "semipolar", color = "#344feb", text = "Deleting Trial - please wait while the dashboard refreshes in background....")

  dbExecute(con, exp_delete())

  if (input$registry_remove == 'NCT_Ids') {
    source('Download_Trial_Info_NCT.R')
  } else if (input$registry_remove == 'ISRCTN_Ids') {
    source('Download_Trial_Info_ISRCTN.R')
  } else if (input$registry_remove == 'NIHR_Ids') {
    source('Download_Trial_Info_NIHR.R')
  } else if (input$registry_remove == 'EU_Ids') {
    source('Download_Trial_Info_EU.R')
  }

  shinybusy::remove_modal_spinner()

  output$success_delete <- renderText("Trial Deleted! Refresh browser for this to update on the live trial lists")

})

observeEvent(input$button_archive, {

  shinybusy::show_modal_spinner(spin = "semipolar", color = "#344feb", text = "Archiving Trial - please wait while the dashboard refreshes in background....")

  pulled_trial_data <- dbGetQuery(con, exp_archive_pull()) %>%
    mutate("Archiving_Comments" = paste(Comments, as.character(input$comments_archive)), collapse = " ") %>%
    slice_max(Query_Date)

  #write to db (append)
  dbWriteTable(con, paste0(str_sub(input$registry_remove, end=-5), "_rxv"), pulled_trial_data, append = TRUE)

  dbExecute(con, exp_delete())

  if (input$registry_remove == 'NCT_Ids') {
    source('Download_Trial_Info_NCT.R')
  } else if (input$registry_remove == 'ISRCTN_Ids') {
    source('Download_Trial_Info_ISRCTN.R')
  } else if (input$registry_remove == 'NIHR_Ids') {
    source('Download_Trial_Info_NIHR.R')
  } else if (input$registry_remove == 'EU_Ids') {
    source('Download_Trial_Info_EU.R')
  }

  shinybusy::remove_modal_spinner()

  #return some success message
  output$success_archive <- renderText("Trial Successfully Archived. It should disappear from live lists and appear in archive on browser refresh")

})

```

### Trial Comments

Select trial and amend comments in the box below

``` {r TrialComments}

inputPanel(
    radioButtons(
      "registry_comment",
      label = "Registry",
      choices = c(
        "Clinicaltrials.gov" = "NCT_Ids",
        "ISRCTN" = "ISRCTN_Ids",
        "NIHR" = "NIHR_Ids",
        "Clinicaltrials.eu" = "EU_Ids"
      )
    ),
    selectInput('ID_comment',
                label = 'Select Trial ID reference number',
                choices = ""),
    textAreaInput("trial_comments", label = "Comments", placeholder = "Trial Comments", resize = "both"),
    actionButton("button_comment", "Amend Comments")
  )

mainPanel(
  #textOutput("comment_sql"),
  #textOutput("fetch_comment_SQL"),
  textOutput("success_comment")
  )

observeEvent(input$registry_comment, {

  choices_list <- dbReadTable(con, "Trial_Ids") %>%
    select(ids = input$registry_comment) %>%
    drop_na() %>%
    arrange(str_remove_all(ids, "[A-Z]|-"))

  updateSelectInput(session, "ID_comment", choices = choices_list)
  
})

sql_comments_pull <- "SELECT Comments FROM ?Orig_Table WHERE [?ColID] = ?comment_id AND Query_Date IN (SELECT max(Query_Date) FROM ?Orig_Table)"

exp_comment_pull <- reactive({
    sqlInterpolate(
      con,
      sql_comments_pull,
      Orig_Table = SQL(str_sub(input$registry_comment, end=-5)),
      ColID = SQL(case_when(input$registry_comment == "NCT_Ids" ~ "NCTId",
                          input$registry_comment == "NIHR_Ids" ~ "project_id",
                          input$registry_comment == "ISRCTN_Ids" ~ "ISRCTN_No",
                          input$registry_comment == "EU_Ids" ~ "EU_Ids")),
      comment_id = input$ID_comment
  )
})

pulled_comments <- reactive({
  dbGetQuery(con, exp_comment_pull()) %>% as.character()
  })  
  
output$comment_sql <- renderText(exp_comment_pull())
output$fetch_comment_SQL <- renderText(pulled_comments())

observeEvent(input$ID_comment, {
  
  updateTextAreaInput(session, "trial_comments", value = pulled_comments())
  
})


observeEvent(input$button_comment, {
  
  #Add spinner
  show_modal_spinner(spin = "semipolar", color = "#344feb", text = "Amending Comments - please wait while the dashboard refreshes in background....")
  
  #Take contents of button
  comment_text <- input$trial_comments
  
  #Derive SQL to insert into table
  comment_insert_sql <- "UPDATE ?TabID SET Comments = ?comment_text WHERE ?ID_name == ?id_no"
  
  update_comment_sql <- 
    sqlInterpolate(con,
                   comment_insert_sql,
                   TabID = SQL(str_sub(input$registry_comment, end=-5)),
                   comment_text = comment_text,
                   ID_name = SQL(case_when(input$registry_comment == "NCT_Ids" ~ "NCTId",
                          input$registry_comment == "NIHR_Ids" ~ "project_id",
                          input$registry_comment == "ISRCTN_Ids" ~ "ISRCTN_No",
                          input$registry_comment == "EU_Ids" ~ "EU_Ids")),
                   id_no = input$ID_comment
                   )
  
  #Action SQL
  dbExecute(con, update_comment_sql)
  
  #Remove spinner
  remove_modal_spinner()

  #return some success message
  output$success_comment <- renderText("Comments Successfully Updated - please refresh dashboard to see updated comments")

  
})

```


Archived Trials
======================================================

Row {.tabset .tabset-fade}
--------------------------------------------------------



### ClinicalTrials.gov Archive

``` {r CG.gov archive}

dbReadTable(con, "NCT_rxv") %>%
  mutate(across(.fns = clean_UTF),
         `Archive Date` = as_date(as.numeric(Query_Date))) %>% 
  select(
         -SeeAlsoLinkURL,
         -Query_Date,
         ) %>% 
  select(`Archive Date`,
         everything(),
         `Archiving Comments` = Archiving_Comments) %>% 
  rename(
    Guideline = Guideline.number,
    `NCT ID` = NCTId,
    `Org ID` = OrgStudyId,
    Title = BriefTitle,
    Status = OverallStatus,
    `Primary Completion Date` = PrimaryCompletionDate,
    `Completion Date` = CompletionDate,
    `Results Submit Date` = ResultsFirstSubmitDate,
    `Results Post Date` = ResultsFirstPostDate,
    `Last Update` = LastUpdatePostDate
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

### ISRCTN Archive

```{r ISRCTN archive table}

dbReadTable(con, "ISRCTN_rxv") %>%
  mutate(across(.fns = clean_UTF),
         `Archive Date` = as_date(as.numeric(Query_Date))) %>% 
  select(-Query_Date) %>% 
  select(`Archive Date`,
         everything()) %>% 
  rename(
    Guideline = Guideline.number,
    `ISRCTN ID` = ISRCTN_No,
    Title = Public_Title,
    `Scientific Title` = Scientific_Title,
    `Recruitment Status` = Recruitment_Status,
    `Results completed date` = Results_date_completed,
    `Results URL` = Results_url_link,
    `Results summary` = Results_summary,
    `Results posted date` = Results_date_posted,
    `Results published date` = Results_date_first_publication,
    `Archiving Comments` = Archiving_Comments
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

### NIHR Archive

``` {r NIHR archive table}

dbReadTable(con, "NIHR_rxv") %>%
  mutate(across(.fns = clean_UTF),
         `Archive Date` = as_date(as.numeric(Query_Date))) %>% 
  select(-Query_Date) %>% 
  select(`Archive Date`,
         everything()) %>% 
  rename(
    Guideline = Guideline.number,
    `NIHR ID` = project_id,
    `Project Title` = project_title,
    Status = project_status,
    `End Date` = end_date,
    `Archiving Comments` = Archiving_Comments
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```

### EU Archive

``` {r EU archive table}

dbReadTable(con, "EU_rxv") %>%
  select(-a31_title_of_the_trial_for_lay_people_in_easily_understood_ie_nontechnical_language, -EU_Ids
  ) %>%
  mutate(across(.fns = clean_UTF)) %>% 
  rename(
    Guideline = Guideline.number,
    `Clinicaltrials.eu ID` = `X_id`,
    `End of Trial Status` = p_end_of_trial_status,
    Title = a3_full_title_of_the_trial,
    `Abbreviated Title` = a32_name_or_abbreviated_title_of_the_trial_where_available,
    `Sponsor ID` = a41_sponsors_protocol_code_number,
    `Archiving Comments` = Archiving_Comments
  ) %>%
  datatable(options = list(bPaginate = FALSE, scrollY = TRUE), filter = "top")

```
